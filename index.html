<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord サーバー参加ツール</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background:#202225; color:#dcddde; font-family:'Whitney',sans-serif; padding:20px; margin:0; }
        .container { max-width:800px; margin:0 auto; }
        header { text-align:center; padding:20px; border-bottom:1px solid #36393f; }
        h1 { color:white; }
        .card { background:#2f3136; border-radius:8px; padding:20px; margin:20px 0; }
        .input-group { display:flex; flex-direction:column; gap:15px; margin-bottom:20px; }
        input { padding:12px; background:#202225; border:none; color:white; border-radius:4px; }
        button { padding:12px 20px; background:#5865F2; color:white; border:none; cursor:pointer; border-radius:4px; }
        button:hover { background:#4752C4; }
        button.danger { background:#ed4245; }
        button.danger:hover { background:#c03537; }
        .result { padding:15px; border-radius:8px; margin-top:20px; font-weight:bold; }
        .success { background:rgba(59,165,93,0.2); border-left:4px solid #3ba55d; }
        .error { background:rgba(237,66,69,0.2); border-left:4px solid #ed4245; }
        .hidden { display:none; }
        .disclaimer { font-size:0.9em; color:#72767d; margin-top:15px; line-height:1.5; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fab fa-discord"></i> Discord サーバー参加ツール</h1>
            <p>ユーザー・トークンで招待リンクからサーバーに参加</p>
        </header>

        <div class="card">
            <h2>トークンと招待リンクを入力</h2>
            <div class="input-group">
                <input type="password" id="token-input" placeholder="Discordユーザー・トークン（保存されます）">
                <input type="text" id="invite-input" placeholder="招待リンクまたはコード（例: abc123 または https://discord.gg/abc123）">
            </div>
            <button id="join-btn">サーバーに参加</button>
            <button id="clear-btn" class="danger" style="margin-left:10px;">トークン削除</button>

            <div class="disclaimer">
                ⚠️ ユーザー・トークンでのサーバー参加は規約グレーゾーンです。過度な使用はアカウント凍結のリスクがあります。<br>
                ⚠️ スパム・迷惑行為には絶対に使用しないでください。<br>
                ⚠️ 自己責任でお使いください。
            </div>
        </div>

        <div id="result" class="result hidden"></div>

        <div class="card hidden" id="user-card">
            <div style="display:flex; align-items:center; gap:15px;">
                <img id="avatar" src="" width="64" height="64" style="border-radius:50%;">
                <div>
                    <h3 id="username">接続済み</h3>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://discord.com/api/v9';
        let token = null;

        // 招待コード抽出
        function extractCode(link) {
            const match = link.match(/discord(?:app)?\.com\/invite\/([a-zA-Z0-9-]+)/) || link.match(/^([a-zA-Z0-9-]+)$/);
            return match ? match[1] : null;
        }

        document.getElementById('join-btn').onclick = async () => {
            token = document.getElementById('token-input').value.trim();
            const rawInvite = document.getElementById('invite-input').value.trim();

            if (!token) return alert('トークンを入力してください');
            if (!rawInvite) return alert('招待リンクまたはコードを入力してください');

            const code = extractCode(rawInvite);
            if (!code) return alert('有効な招待リンクまたはコードを入力してください');

            localStorage.setItem('discord_token', token); // 保存

            const resultDiv = document.getElementById('result');
            resultDiv.classList.remove('hidden', 'success', 'error');

            try {
                // まず自分の情報取得（トークン確認）
                const meRes = await fetch(`${API}/users/@me`, { headers: { 'Authorization': token } });
                if (!meRes.ok) throw new Error('トークンが無効です');

                const me = await meRes.json();
                document.getElementById('username').textContent = me.global_name || me.username;
                document.getElementById('avatar').src = me.avatar 
                    ? `https://cdn.discordapp.com/avatars/${me.id}/${me.avatar}.png?size=128`
                    : 'https://cdn.discordapp.com/embed/avatars/0.png';
                document.getElementById('user-card').classList.remove('hidden');

                // サーバー参加
                const joinRes = await fetch(`${API}/invites/${code}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (joinRes.ok) {
                    const data = await joinRes.json();
                    const serverName = data.guild?.name || '不明なサーバー';
                    resultDiv.classList.add('success');
                    resultDiv.innerHTML = `<i class="fas fa-check-circle"></i> 成功！「${serverName}」に参加しました！`;
                } else {
                    const err = await joinRes.json().catch(() => ({}));
                    let msg = err.message || '不明なエラー';
                    if (joinRes.status === 404) msg = '招待リンクが無効または期限切れです';
                    if (joinRes.status === 403) msg = '参加権限がありません（BAN済みなど）';
                    if (joinRes.status === 429) msg = 'レートリミット（しばらく待ってください）';

                    resultDiv.classList.add('error');
                    resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> 失敗: ${msg}`;
                }
            } catch (e) {
                resultDiv.classList.add('error');
                resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> エラー: ${e.message}`;
            }
        };

        document.getElementById('clear-btn').onclick = () => {
            if (confirm('保存されたトークンを削除しますか？')) {
                localStorage.removeItem('discord_token');
                document.getElementById('token-input').value = '';
                document.getElementById('user-card').classList.add('hidden');
                alert('トークンを削除しました');
            }
        };

        // 自動入力
        const saved = localStorage.getItem('discord_token');
        if (saved) {
            document.getElementById('token-input').value = saved;
        }
    </script>
</body>
</html>
