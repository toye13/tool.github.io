<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord ユーザー検索ツール（データ永続化版）</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background:#202225; color:#dcddde; font-family:'Whitney',sans-serif; padding:20px; margin:0; }
        .container { max-width:800px; margin:0 auto; }
        header { text-align:center; padding:20px; border-bottom:1px solid #36393f; }
        h1, h2 { color:white; }
        .card { background:#2f3136; border-radius:8px; padding:20px; margin:20px 0; }
        .input-group { display:flex; margin-bottom:15px; }
        input { flex:1; padding:12px; background:#202225; border:none; color:white; border-radius:4px 0 0 4px; }
        button { padding:12px 20px; background:#5865F2; color:white; border:none; cursor:pointer; border-radius:0 4px 4px 0; }
        button:hover { background:#4752C4; }
        button.danger { background:#ed4245; }
        button.danger:hover { background:#c03537; }
        #results-list li { padding:12px; margin:8px 0; border-radius:4px; word-break:break-all; }
        .success { background:rgba(59,165,93,0.2); border-left:4px solid #3ba55d; }
        .error { background:rgba(237,66,69,0.2); border-left:4px solid #ed4245; }
        .info { background:rgba(88,101,242,0.2); border-left:4px solid #5865F2; }
        .hidden { display:none; }
        .display-name { font-size:1.4em; font-weight:bold; color:#fff; margin:5px 0; }
        .username { color:#b9bbbe; }
        .user-id { font-size:0.9em; color:#72767d; }
        .email-info { margin-top:8px; color:#8b8fff; font-size:0.9em; }
        .search-history { margin-top:10px; font-size:0.9em; color:#72767d; }
        .search-history-item { cursor:pointer; color:#5865F2; }
        .search-history-item:hover { text-decoration:underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Discord ユーザー検索ツール</h1>
            <p>データ永続化版（トークン・フレンド・履歴が残ります）</p>
        </header>

        <div id="token-card" class="card">
            <h2>トークンを入力</h2>
            <div class="input-group">
                <input type="password" id="token-input" placeholder="Discordトークン（保存されます）">
                <button id="connect-btn">接続</button>
            </div>
            <p style="font-size:0.9em;">※ 保存されたトークンはこのブラウザ内のみ。ログアウトで削除可能</p>
        </div>

        <div id="user-card" class="card hidden">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img id="avatar" src="" width="64" height="64" style="border-radius:50%;">
                    <div>
                        <div class="display-name" id="display-name">読み込み中...</div>
                        <div class="username" id="username-tag"></div>
                    </div>
                </div>
                <button id="logout-btn" class="danger">全データ削除＆ログアウト</button>
            </div>
        </div>

        <div id="check-card" class="card hidden">
            <h2>ユーザー検索</h2>
            <p>表示名・ユーザー名・ID で検索（フレンド内）</p>
            <div class="input-group">
                <input type="text" id="search-input" placeholder="例: ななち, nanachi#0000, ID">
                <button id="search-btn">検索</button>
            </div>
            <div class="search-history" id="history"></div>
        </div>

        <div id="results-card" class="card hidden">
            <h2>検索結果</h2>
            <ul id="results-list"></ul>
        </div>
    </div>

    <script>
        const API = 'https://discord.com/api/v9';
        let token = null;
        let friends = [];
        let searchHistory = [];

        // localStorageからデータ復元
        function loadData() {
            const savedToken = localStorage.getItem('discord_token');
            const savedFriends = localStorage.getItem('discord_friends');
            const savedHistory = localStorage.getItem('discord_history');

            if (savedToken) {
                document.getElementById('token-input').value = savedToken;
            }
            if (savedFriends) {
                friends = JSON.parse(savedFriends);
            }
            if (savedHistory) {
                searchHistory = JSON.parse(savedHistory);
                updateHistoryUI();
            }

            if (savedToken && friends.length > 0) {
                autoConnect(savedToken);
            }
        }

        async function autoConnect(savedToken) {
            token = savedToken;
            try {
                const me = friends[0]; // 自分は先頭
                document.getElementById('display-name').textContent = me.global_name || me.username;
                document.getElementById('username-tag').textContent = me.global_name ? `${me.username}#${me.discriminator || '0'}` : '';
                document.getElementById('avatar').src = me.avatar 
                    ? `https://cdn.discordapp.com/avatars/${me.id}/${me.avatar}.png?size=128`
                    : 'https://cdn.discordapp.com/embed/avatars/0.png';

                document.getElementById('token-card').classList.add('hidden');
                document.getElementById('user-card').classList.remove('hidden');
                document.getElementById('check-card').classList.remove('hidden');
                document.getElementById('results-card').classList.remove('hidden');
                addResult('info', `自動接続成功！フレンド ${friends.length-1}人 を読み込み済み`);
            } catch (e) {
                localStorage.clear();
                alert('保存されたデータが無効です。全データ削除しました。');
            }
        }

        document.getElementById('connect-btn').onclick = async () => {
            token = document.getElementById('token-input').value.trim();
            if (!token) return alert('トークンを入力してください');

            localStorage.setItem('discord_token', token); // 保存

            try {
                const meRes = await fetch(`${API}/users/@me`, { headers: { 'Authorization': token } });
                if (!meRes.ok) throw new Error('無効なトークン');
                const me = await meRes.json();

                document.getElementById('display-name').textContent = me.global_name || me.username;
                document.getElementById('username-tag').textContent = me.global_name ? `${me.username}#${me.discriminator || '0'}` : '';
                document.getElementById('avatar').src = me.avatar 
                    ? `https://cdn.discordapp.com/avatars/${me.id}/${me.avatar}.png?size=128`
                    : 'https://cdn.discordapp.com/embed/avatars/0.png';

                // フレンド取得＆保存
                const relRes = await fetch(`${API}/users/@me/relationships`, { headers: { 'Authorization': token } });
                const relations = await relRes.json();
                friends = [me];

                for (const rel of relations) {
                    if (rel.type === 1) {
                        try {
                            const uRes = await fetch(`${API}/users/${rel.id}`, { headers: { 'Authorization': token } });
                            if (uRes.ok) friends.push(await uRes.json());
                        } catch {}
                    }
                }

                localStorage.setItem('discord_friends', JSON.stringify(friends)); // 保存

                document.getElementById('token-card').classList.add('hidden');
                document.getElementById('user-card').classList.remove('hidden');
                document.getElementById('check-card').classList.remove('hidden');
                document.getElementById('results-card').classList.remove('hidden');
                addResult('info', `接続成功！フレンド ${friends.length-1}人 を保存しました`);
            } catch (e) {
                alert('エラー: ' + e.message);
            }
        };

        function addResult(type, html) {
            const li = document.createElement('li');
            li.className = type;
            li.innerHTML = html;
            document.getElementById('results-list').prepend(li);
        }

        function updateHistoryUI() {
            const hist = document.getElementById('history');
            hist.innerHTML = '検索履歴: ';
            searchHistory.slice().reverse().forEach((q, i) => {
                const span = document.createElement('span');
                span.textContent = q;
                span.className = 'search-history-item';
                span.onclick = () => {
                    document.getElementById('search-input').value = q;
                    document.getElementById('search-btn').click();
                };
                hist.appendChild(span);
                if (i < searchHistory.length - 1) hist.appendChild(document.createTextNode(' | '));
            });
        }

        document.getElementById('search-btn').onclick = () => {
            let q = document.getElementById('search-input').value.trim();
            if (!q) return;

            // 履歴に追加（重複除去）
            if (!searchHistory.includes(q)) {
                searchHistory.unshift(q);
                if (searchHistory.length > 20) searchHistory.pop();
                localStorage.setItem('discord_history', JSON.stringify(searchHistory));
                updateHistoryUI();
            }

            document.getElementById('results-list').innerHTML = '';

            const query = q.toLowerCase();
            let found = false;

            for (const user of friends) {
                const display = (user.global_name || user.username || '').toLowerCase();
                const username = user.username.toLowerCase();
                const full = `${user.username}#${user.discriminator || '0'}`.toLowerCase();
                const id = user.id;

                if (id === query || display.includes(query) || username.includes(query) || full.includes(query)) {
                    const dispName = user.global_name || user.username;
                    let html = `
                        <div class="display-name">${dispName}</div>
                        <div class="username">${user.username}#${user.discriminator || '0'}</div>
                        <div class="user-id">ID: ${user.id}</div>
                    `;
                    if (user.email) {
                        html += `<div class="email-info">メール: ${user.email} ${user.verified ? '認証済' : '未認証'}</div>`;
                    }
                    addResult('success', html);
                    found = true;
                }
            }

            if (!found) addResult('error', `「${q}」に一致するユーザーは見つかりませんでした`);
            document.getElementById('search-input').value = '';
        };

        document.getElementById('logout-btn').onclick = () => {
            if (confirm('すべての保存データを削除してログアウトしますか？')) {
                localStorage.clear();
                location.reload();
            }
        };

        document.getElementById('search-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') document.getElementById('search-btn').click();
        });

        // ページ読み込み時にデータ復元
        loadData();
    </script>
</body>
</html>
