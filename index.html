<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord カスタムプロフィール設定ツール</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background:#202225; color:#dcddde; font-family:'Whitney',sans-serif; padding:20px; margin:0; }
        .container { max-width:900px; margin:0 auto; }
        header { text-align:center; padding:20px; border-bottom:1px solid #36393f; }
        h1 { color:white; }
        .card { background:#2f3136; border-radius:8px; padding:20px; margin:20px 0; }
        .input-group { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px; }
        @media (max-width:700px) { .input-group { grid-template-columns:1fr; } }
        label { display:block; margin-bottom:5px; }
        input, textarea, select { width:100%; padding:12px; background:#202225; border:none; color:white; border-radius:4px; }
        textarea { height:100px; resize:vertical; }
        button { padding:12px 20px; background:#5865F2; color:white; border:none; cursor:pointer; border-radius:4px; margin-right:10px; margin-top:10px; }
        button:hover { background:#4752C4; }
        button.danger { background:#ed4245; }
        button.danger:hover { background:#c03537; }
        .preview { background:#36393f; padding:20px; border-radius:8px; margin-top:20px; text-align:center; }
        .preview-banner { width:100%; height:180px; background:#43b581; border-radius:8px; background-size:cover; background-position:center; margin-bottom:20px; }
        .preview-avatar { width:120px; height:120px; border-radius:50%; border:6px solid #2f3136; margin-top:-70px; background:#7289da; }
        .preview-name { font-size:1.8em; font-weight:bold; margin:10px 0; }
        .preview-bio { margin:15px 0; color:#b9bbbe; }
        .hidden { display:none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fab fa-discord"></i> Discord カスタムプロフィール設定</h1>
            <p>バナー・自己紹介・カラー・ステータスを自由にカスタマイズ（永続化対応）</p>
        </header>

        <div id="token-card" class="card">
            <h2>トークンを入力</h2>
            <input type="password" id="token-input" placeholder="Discordユーザートークン">
            <button id="connect-btn">接続</button>
        </div>

        <div id="main-card" class="card hidden">
            <h2>プロフィール設定</h2>
            <div class="input-group">
                <div>
                    <label>バナー画像URL（横長推奨）</label>
                    <input type="text" id="banner-url" placeholder="https://example.com/banner.jpg">
                </div>
                <div>
                    <label>プロフィールカラー（16進数 #RRGGBB）</label>
                    <input type="text" id="accent-color" placeholder="#5865F2">
                </div>
            </div>
            <label>自己紹介（Bio）</label>
            <textarea id="bio" placeholder="ここに自己紹介を書けます..."></textarea>

            <h3 style="margin-top:30px;">カスタムステータス（プレイ中）</h3>
            <div class="input-group">
                <div>
                    <label>ゲーム名</label>
                    <input type="text" id="game-name" placeholder="例: 原神 プレイ中">
                </div>
                <div>
                    <label>詳細テキスト</label>
                    <input type="text" id="details" placeholder="例: テイワット探索中">
                </div>
            </div>
            <div class="input-group">
                <div>
                    <label>経過時間</label>
                    <select id="timestamp-mode">
                        <option value="none">なし</option>
                        <option value="now">今から開始</option>
                    </select>
                </div>
                <div>
                    <label>アイコンURL</label>
                    <input type="text" id="icon-url" placeholder="https://example.com/icon.png">
                </div>
            </div>

            <button id="apply-all">すべて適用</button>
            <button id="clear-all" class="danger">プロフィール初期化</button>

            <div class="preview">
                <h3>プレビュー</h3>
                <div class="preview-banner" id="preview-banner"></div>
                <img class="preview-avatar" id="preview-avatar" src="">
                <div class="preview-name" id="preview-name">あなたの名前</div>
                <div class="preview-bio" id="preview-bio">自己紹介がここに表示されます</div>
                <div id="preview-status"></div>
            </div>
        </div>

        <div id="user-card" class="card hidden">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img id="avatar" src="" width="64" height="64" style="border-radius:50%;">
                    <h3 id="username">読み込み中...</h3>
                </div>
                <button id="logout-btn" class="danger">全データ削除＆ログアウト</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://discord.com/api/v9';
        let token = null;
        let userData = null;
        let startTime = null;

        function updatePreview() {
            const banner = document.getElementById('banner-url').value;
            if (banner) {
                document.getElementById('preview-banner').style.backgroundImage = `url(${banner})`;
            } else {
                document.getElementById('preview-banner').style.backgroundImage = '';
                document.getElementById('preview-banner').style.backgroundColor = '#43b581';
            }

            document.getElementById('preview-bio').textContent = document.getElementById('bio').value || '自己紹介がここに表示されます';

            const game = document.getElementById('game-name').value;
            const details = document.getElementById('details').value;
            let statusHTML = '';
            if (game || details) {
                statusHTML = `<div style="margin-top:15px; text-align:left;">
                    <strong>${game || 'ゲーム名'}</strong><br>
                    <span style="color:#b9bbbe;">${details || '詳細テキスト'}</span>`;
                if (document.getElementById('timestamp-mode').value === 'now' && startTime) {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
                    const s = String(elapsed % 60).padStart(2, '0');
                    statusHTML += `<br><span style="color:#72767d;">${m}:${s} 経過</span>`;
                }
                statusHTML += '</div>';
            }
            document.getElementById('preview-status').innerHTML = statusHTML;
        }

        async function applyProfile() {
            const banner = document.getElementById('banner-url').value.trim();
            const color = document.getElementById('accent-color').value.trim();
            const bio = document.getElementById('bio').value.trim();

            const payload = {
                bio: bio || null,
                accent_color: color ? parseInt(color.replace('#', ''), 16) : null
            };

            if (banner) {
                payload.banner = banner;
            }

            try {
                await fetch(`${API}/users/@me/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                alert('プロフィール設定失敗: ' + e.message);
            }

            // カスタムステータス
            const game = document.getElementById('game-name').value.trim();
            const details = document.getElementById('details').value.trim();
            const icon = document.getElementById('icon-url').value.trim();

            const activities = [];
            if (game || details) {
                const act = {
                    name: game || "Discord",
                    type: 0,
                    details: details || undefined,
                    assets: icon ? { large_image: icon } : undefined,
                    timestamps: {}
                };
                if (document.getElementById('timestamp-mode').value === 'now') {
                    startTime = Date.now();
                    act.timestamps.start = startTime;
                }
                activities.push(act);
            }

            try {
                await fetch(`${API}/users/@me/settings`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ activities })
                });
                alert('カスタムプロフィール適用完了！（アプリ再起動で反映）');
                updatePreview();
            } catch (e) {
                alert('ステータス設定失敗: ' + e.message);
            }
        }

        async function clearProfile() {
            if (!confirm('プロフィールを初期状態に戻しますか？')) return;
            try {
                await fetch(`${API}/users/@me/profile`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ banner: null, accent_color: null, bio: null })
                });
                await fetch(`${API}/users/@me/settings`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ activities: [] })
                });
                alert('プロフィール初期化完了');
                location.reload();
            } catch (e) {
                alert('初期化失敗: ' + e.message);
            }
        }

        document.getElementById('connect-btn').onclick = async () => {
            token = document.getElementById('token-input').value.trim();
            if (!token) return alert('トークンを入力してください');
            localStorage.setItem('discord_token', token);

            try {
                const res = await fetch(`${API}/users/@me`, { headers: { 'Authorization': token } });
                if (!res.ok) throw new Error('無効なトークン');
                userData = await res.json();

                document.getElementById('username').textContent = userData.global_name || userData.username;
                document.getElementById('avatar').src = userData.avatar 
                    ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png?size=128`
                    : 'https://cdn.discordapp.com/embed/avatars/0.png';
                document.getElementById('preview-avatar').src = document.getElementById('avatar').src;
                document.getElementById('preview-name').textContent = userData.global_name || userData.username;

                document.getElementById('token-card').classList.add('hidden');
                document.getElementById('main-card').classList.remove('hidden');
                document.getElementById('user-card').classList.remove('hidden');

                updatePreview();
            } catch (e) {
                alert('接続失敗: ' + e.message);
            }
        };

        document.getElementById('apply-all').onclick = applyProfile;
        document.getElementById('clear-all').onclick = clearProfile;

        // リアルタイムプレビュー
        document.querySelectorAll('input, textarea, select').forEach(el => {
            el.addEventListener('input', updatePreview);
        });

        document.getElementById('logout-btn').onclick = () => {
            if (confirm('全データ削除しますか？')) {
                localStorage.clear();
                location.reload();
            }
        };

        // 自動接続
        const saved = localStorage.getItem('discord_token');
        if (saved) {
            document.getElementById('token-input').value = saved;
            document.getElementById('connect-btn').click();
        }

        updatePreview();
    </script>
</body>
</html>
